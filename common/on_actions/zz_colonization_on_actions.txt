# Root = State
on_monthly_pulse_state = {
	on_actions = {
		colonial_progress_claim_check_on_action
	}
}

# Root = Colony state
on_colony_created = {
	on_actions = {
		max_colonial_capacity_on_action
		barracks_building_on_action
	}
}

# The Major/Minor Colonies system is handled here
colonial_progress_claim_check_on_action = {
	effect = {
		if = {
			limit = {
				owner.country_rank >= rank_value:great_power
				NOT = { owner = { has_claim = root.state_region } }
				state_is_colony = yes
				num_provinces >= state_region_num_provinces_half
				state_is_claimed_state = yes
			} 
			state_region = {
				add_claim = root.owner
			}
			every_state = {
				limit = {
					NOT = { owner = root.owner }
					owner.country_rank >= rank_value:great_power
					state_region = root.state_region
					num_provinces >= state_region_num_provinces_fifth
				}
				save_scope_as = minor_colony_scope
				state_region = {
					add_claim = scope:minor_colony_scope.owner
				}
			}
			root = {
				save_scope_as = colony_notification_state
			}
			root.owner = {
				save_scope_as = colonizer_notification_country
				post_notification = zz_colony_development_major
			}
			every_country = {
				limit = {
					has_interest_marker_in_region = root.region
					is_ai = no
					NOT = {
						this = root.owner
					}					
				}
				post_notification = zz_colony_development_major_other
			}										
		}
	}
}

# Check if we are eligible for a colony
max_colonial_capacity_on_action = {
	effect = {
		if = {
			limit = {
				root.owner = {
					OR = {
						country_is_colonial_capped = yes
						is_diplomatic_play_committed_participant = yes # These last two stop players/AI from continuing to colonize into Africa while you are at war over a state
						is_at_war = yes
					}
				}
				NOT = { num_provinces > 1 } # When we acquire a colony through other means we are allowed to resume colonizing even if we are capped
			}		
			random_neighbouring_state = { # The actual functionality is that we immediately return the colony to a neighboring decentralized nation if we are capped, this has some minor jank (try spam clicking colonies on Mauritania) which can be resolved but this will do 90% of the time.
				limit = {
					state_region = root.state_region
					owner = {
						is_country_type = decentralized
					}
				}
				owner = {
					save_scope_as = decentralized_native_country
				}
			}
			set_state_owner = scope:decentralized_native_country						
		}
		else = {
			root = {
				save_scope_as = colony_notification_state
			}
			root.owner = {
				save_scope_as = colonizer_notification_country
				add_to_variable_list = {
					name = my_colonies_list
					target = root
				}
			}
			every_country = {
				limit = {
					has_interest_marker_in_region = root.region
					is_ai = no
					NOT = {
						this = root.owner
					}
				}
				post_notification = zz_colony_created # replacing the original vanilla colony notification
			}
		}
	}
}



### The AI is notoriously dogshit in taking care of its colonies so we try to alleviate this a little by giving them a free barrack
barracks_building_on_action = {
	effect = {
		if = {
			limit = {
				is_incorporated = no
				state_in_africa = yes
				is_under_colonization = yes
				NOT = {
					has_building = building_barracks
				}
				root.owner = {
					country_is_in_africa = no
					is_ai = yes
				}
			}
			create_building = {
				building = building_barracks
				level = 1
			}
		}
	}
}